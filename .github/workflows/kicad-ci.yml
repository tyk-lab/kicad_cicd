# KiCadé¡¹ç›®è‡ªåŠ¨åŒ–æ„å»ºå·¥ä½œæµ
# åŠŸèƒ½ï¼šERC/DRCæ£€æŸ¥ã€å¯¼å‡ºåŸç†å›¾PDFã€BOMã€Gerberæ–‡ä»¶å’ŒPCBå›¾åƒ
name: KiCad CI/CD

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°ä¸»åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - main      # ä¸»åˆ†æ”¯æ¨é€æ—¶è§¦å‘
      - master    # æˆ–masteråˆ†æ”¯æ¨é€æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘

jobs:
  kicad-checks:
    runs-on: windows-latest  # ä½¿ç”¨Windowså¹³å°è¿è¡Œ
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # æ­¥éª¤2ï¼šå®‰è£…KiCadæœ€æ–°ç‰ˆæœ¬åŠå…¶åº“æ–‡ä»¶
      - name: Setup KiCad environment
        run: |
          Write-Host "ğŸ“¦ Installing KiCad 9.0.6..."
          # ä½¿ç”¨Chocolateyå®‰è£…KiCadæœ€æ–°ç‰ˆæœ¬ 9.0.6
          choco install kicad --version=9.0.6 -y
          
          Write-Host "âœ… KiCad installation completed"
        shell: powershell
      
      # æ­¥éª¤2.5ï¼šéªŒè¯KiCadå®‰è£…
      - name: Verify KiCad installation
        run: |
          Write-Host "Verifying KiCad installation..."
          
          # æ£€æŸ¥kicad-cli.exeæ˜¯å¦å­˜åœ¨
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          if (Test-Path $kicadCli) {
            Write-Host "Found kicad-cli.exe at: $kicadCli"
            
            # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
            Write-Host ""
            Write-Host "KiCad Version:"
            & $kicadCli version
          } else {
            Write-Host "kicad-cli.exe not found at: $kicadCli"
            Write-Host ""
            Write-Host "Searching for KiCad installation..."
            
            # æŸ¥æ‰¾KiCadå®‰è£…ç›®å½•
            if (Test-Path "C:\Program Files\KiCad") {
              Get-ChildItem "C:\Program Files\KiCad" -Recurse -Filter "kicad-cli.exe" -ErrorAction SilentlyContinue | ForEach-Object {
                Write-Host "Found: $($_.FullName)"
              }
            }
            
            exit 1
          }
        shell: powershell
      
      # æ­¥éª¤3ï¼šè¿è¡ŒERCæ£€æŸ¥ï¼ˆç”µæ°”è§„åˆ™æ£€æŸ¥ï¼‰
      # æ£€æŸ¥åŸç†å›¾ä¸­çš„ç”µæ°”è¿æ¥é”™è¯¯ï¼Œå¦‚æœªè¿æ¥çš„å¼•è„šã€ç”µæºå†²çªç­‰
      - name: Run ERC (Electrical Rules Check)
        run: |
          Write-Host "Starting ERC check..."
          
          # æ£€æŸ¥åŸç†å›¾æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          $schFile = "229_Test.kicad_sch"
          if (-not (Test-Path $schFile)) {
            Write-Host "Schematic file not found: $schFile"
            Write-Host ""
            Write-Host "Available .kicad_sch files:"
            Get-ChildItem -Filter "*.kicad_sch"
            exit 1
          }
          Write-Host "Found schematic file: $schFile"
          
          # ä½¿ç”¨å®Œæ•´è·¯å¾„è°ƒç”¨kicad-cli
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          Write-Host ""
          Write-Host "Running ERC check with: $kicadCli"
          
          try {
            & $kicadCli sch erc --format json --output erc_report.json $schFile
            $exitCode = $LASTEXITCODE
            
            if ($exitCode -eq 0) {
              Write-Host "ERC check completed successfully"
            } else {
              Write-Host "ERC check completed with warnings/errors (exit code: $exitCode)"
            }
          } catch {
            Write-Host "ERC check failed: $_"
            Write-Host $_.Exception.Message
            exit 1
          }
          
          # æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦ç”Ÿæˆå¹¶è¾“å‡ºå†…å®¹
          if (Test-Path erc_report.json) {
            Write-Host ""
            Write-Host "ERC Report:"
            Write-Host "==========================================="
            Get-Content erc_report.json | Write-Host
            Write-Host "==========================================="
          } else {
            Write-Host "ERC report file was not generated"
          }
        shell: powershell
      
      # æ­¥éª¤4ï¼šè¿è¡ŒDRCæ£€æŸ¥ï¼ˆè®¾è®¡è§„åˆ™æ£€æŸ¥ï¼‰
      # æ£€æŸ¥PCBè®¾è®¡ä¸­çš„å¸ƒçº¿é”™è¯¯ï¼Œå¦‚é—´è·ä¸è¶³ã€æ‚¬ç©ºèµ°çº¿ç­‰
      - name: Run DRC (Design Rules Check)
        run: |
          Write-Host "Starting DRC check..."
          
          # æ£€æŸ¥PCBæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          $pcbFile = "229_Test.kicad_pcb"
          if (-not (Test-Path $pcbFile)) {
            Write-Host "PCB file not found: $pcbFile"
            Write-Host ""
            Write-Host "Available .kicad_pcb files:"
            Get-ChildItem -Filter "*.kicad_pcb"
            exit 1
          }
          Write-Host "Found PCB file: $pcbFile"
          
          # ä½¿ç”¨å®Œæ•´è·¯å¾„è°ƒç”¨kicad-cli
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          Write-Host ""
          Write-Host "Running DRC check with: $kicadCli"
          
          try {
            & $kicadCli pcb drc --format json --output drc_report.json $pcbFile
            $exitCode = $LASTEXITCODE
            
            if ($exitCode -eq 0) {
              Write-Host "DRC check completed successfully"
            } else {
              Write-Host "DRC check completed with warnings/errors (exit code: $exitCode)"
            }
          } catch {
            Write-Host "DRC check failed: $_"
            Write-Host $_.Exception.Message
            exit 1
          }
          
          # æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦ç”Ÿæˆå¹¶è¾“å‡ºå†…å®¹
          if (Test-Path drc_report.json) {
            Write-Host ""
            Write-Host "DRC Report:"
            Write-Host "==========================================="
            Get-Content drc_report.json | Write-Host
            Write-Host "==========================================="
          } else {
            Write-Host "DRC report file was not generated"
          }
        shell: powershell
      
      # æ­¥éª¤5ï¼šå¯¼å‡ºåŸç†å›¾ä¸ºPDFæ–‡æ¡£
      - name: Export Schematic PDF
        run: |
          Write-Host "Exporting schematic to PDF..."
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Force -Path outputs
          # å°†åŸç†å›¾å¯¼å‡ºä¸ºPDFæ ¼å¼ï¼Œæ–¹ä¾¿æŸ¥çœ‹å’Œæ‰“å°
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          & $kicadCli sch export pdf --output outputs/229_Test-Schematic.pdf 229_Test.kicad_sch
          Write-Host "Schematic PDF exported"
        shell: powershell
      
      # æ­¥éª¤6ï¼šå¯¼å‡ºBOMï¼ˆç‰©æ–™æ¸…å•ï¼‰
      - name: Export BOM
        run: |
          Write-Host "Exporting BOM..."
          # ä»åŸç†å›¾å¯¼å‡ºBOMæ¸…å•ï¼ˆCSVæ ¼å¼ï¼‰ï¼ŒåŒ…å«æ‰€æœ‰å…ƒä»¶ä¿¡æ¯
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          & $kicadCli sch export bom --output outputs/229_Test-BOM.csv 229_Test.kicad_sch
          Write-Host "BOM exported"
        shell: powershell
      
      # æ­¥éª¤7ï¼šç”ŸæˆGerberåˆ¶é€ æ–‡ä»¶
      - name: Generate Gerber files
        run: |
          Write-Host "Generating Gerber files..."
          # åˆ›å»ºGerberè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Force -Path outputs/gerber
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          
          # å¯¼å‡ºæ‰€æœ‰Gerberå±‚æ–‡ä»¶ï¼ˆç”¨äºPCBåˆ¶é€ ï¼‰
          & $kicadCli pcb export gerbers --output outputs/gerber/ 229_Test.kicad_pcb
          Write-Host "Gerber layers exported"
          
          # ç”Ÿæˆé’»å­”æ–‡ä»¶ï¼ˆExcellonæ ¼å¼ï¼‰
          & $kicadCli pcb export drill --format excellon --output outputs/gerber/ 229_Test.kicad_pcb
          Write-Host "Drill files generated"
        shell: powershell
      
      # æ­¥éª¤8ï¼šå¯¼å‡ºPCBå¯è§†åŒ–å›¾åƒ
      - name: Export PCB images
        run: |
          Write-Host "Exporting PCB images..."
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          
          # å¯¼å‡ºPCBæ­£é¢è§†å›¾ï¼ˆSVGæ ¼å¼ï¼‰
          # åŒ…å«æ­£é¢é“œå±‚ã€é˜»ç„Šå±‚ã€ä¸å°å±‚å’Œæ¿æ¡†
          & $kicadCli pcb export svg --output outputs/229_Test-PCB-Front.svg --layers F.Cu,F.Mask,F.Silkscreen,Edge.Cuts 229_Test.kicad_pcb
          Write-Host "Front PCB image exported"
          
          # å¯¼å‡ºPCBèƒŒé¢è§†å›¾ï¼ˆSVGæ ¼å¼ï¼‰
          # åŒ…å«èƒŒé¢é“œå±‚ã€é˜»ç„Šå±‚ã€ä¸å°å±‚å’Œæ¿æ¡†
          & $kicadCli pcb export svg --output outputs/229_Test-PCB-Back.svg --layers B.Cu,B.Mask,B.Silkscreen,Edge.Cuts 229_Test.kicad_pcb
          Write-Host "Back PCB image exported"
          
          # å°è¯•å¯¼å‡º3D STEPæ¨¡å‹ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          # å¤±è´¥æ—¶ä¸ä¸­æ–­å·¥ä½œæµ
          try {
            & $kicadCli pcb export step --output outputs/229_Test-3D.step 229_Test.kicad_pcb
            Write-Host "3D STEP model exported"
          } catch {
            Write-Host "3D export skipped (may require 3D models)"
          }
        shell: powershell
      
      # æ­¥éª¤9ï¼šæ‰“åŒ…Gerberæ–‡ä»¶ä¸ºZIPå‹ç¼©åŒ…
      - name: Create Gerber ZIP archive
        run: |
          # å°†æ‰€æœ‰Gerberæ–‡ä»¶æ‰“åŒ…ï¼Œæ–¹ä¾¿ä¸‹è½½å’Œæäº¤ç»™PCBå‚å•†
          Compress-Archive -Path outputs/gerber/* -DestinationPath outputs/229_Test-Gerber.zip -Force
        shell: powershell
      
      # æ­¥éª¤10ï¼šä¸Šä¼ æ„å»ºäº§ç‰©åˆ°GitHub Artifacts
      # å¯åœ¨Actionsé¡µé¢ä¸‹è½½ï¼Œä¿ç•™90å¤©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kicad-outputs
          path: outputs/
      
      # æ­¥éª¤11ï¼šç”Ÿæˆæ„å»ºæ‘˜è¦æ–‡æ¡£
      - name: Update README with status
        run: |
          # åˆ›å»ºåŒ…å«æ„å»ºä¿¡æ¯çš„Markdownæ‘˜è¦æ–‡ä»¶
          # è¯¥æ–‡ä»¶å°†è¢«ç”¨ä½œReleaseçš„è¯´æ˜
          $buildDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC")
          @"
          ## Build Summary
          
          - **Build Date**: $buildDate
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          
          ### Outputs
          
          - âœ… Schematic PDF
          - âœ… BOM (Bill of Materials)
          - âœ… Gerber files
          - âœ… PCB Images (SVG)
          
          "@ | Out-File -FilePath outputs/build_summary.md -Encoding utf8
        shell: powershell
      
      # æ­¥éª¤12ï¼šåˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
      # ä»…åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶æ‰§è¡Œï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸åˆ›å»ºReleaseï¼‰
      - name: Create Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}          # ä½¿ç”¨æ„å»ºç¼–å·ä½œä¸ºæ ‡ç­¾
          name: Build ${{ github.run_number }}              # Releaseæ ‡é¢˜
          body_path: outputs/build_summary.md               # Releaseè¯´æ˜å†…å®¹
          files: |                                           # è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
            outputs/229_Test-Schematic.pdf
            outputs/229_Test-BOM.csv
            outputs/229_Test-Gerber.zip
            outputs/229_Test-PCB-Front.svg
            outputs/229_Test-PCB-Back.svg
            outputs/229_Test-3D.step
            erc_report.json
            drc_report.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}         # ä½¿ç”¨GitHubæä¾›çš„è®¿é—®ä»¤ç‰Œ
