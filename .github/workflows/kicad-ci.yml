# KiCadé¡¹ç›®è‡ªåŠ¨åŒ–æ„å»ºå·¥ä½œæµ
# åŠŸèƒ½ï¼šERC/DRCæ£€æŸ¥ã€å¯¼å‡ºåŸç†å›¾PDFã€BOMã€Gerberæ–‡ä»¶å’ŒPCBå›¾åƒ
name: KiCad CI/CD

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°ä¸»åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - main      # ä¸»åˆ†æ”¯æ¨é€æ—¶è§¦å‘
      - master    # æˆ–masteråˆ†æ”¯æ¨é€æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘

# è®¾ç½®GitHub Tokenæƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»ºreleaseå’Œä¸Šä¼ æ–‡ä»¶

jobs:
  kicad-checks:
    runs-on: windows-latest  # ä½¿ç”¨Windowså¹³å°è¿è¡Œ
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # æ­¥éª¤2ï¼šç¼“å­˜KiCadå®‰è£…
      - name: Cache KiCad installation
        id: cache-kicad
        uses: actions/cache@v4
        with:
          path: |
            C:\Program Files\KiCad\9.0
            C:\ProgramData\chocolatey\lib\kicad
          key: kicad-9.0.6-${{ runner.os }}-${{ hashFiles('.github/workflows/kicad-ci.yml') }}
          restore-keys: |
            kicad-9.0.6-${{ runner.os }}-
            kicad-9.0.6-
      
      # æ­¥éª¤3ï¼šæ£€æŸ¥KiCadæ˜¯å¦å·²ç¼“å­˜
      - name: Check KiCad from cache
        id: check-kicad
        run: |
          Write-Host "Cache hit status: ${{ steps.cache-kicad.outputs.cache-hit }}"
          Write-Host "Checking KiCad installation..."
          
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          if (Test-Path $kicadCli) {
            Write-Host "KiCad found at: $kicadCli"
            & $kicadCli version
            "cached=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "KiCad not found, will install"
            "cached=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }
        shell: powershell
      
      # æ­¥éª¤4ï¼šå®‰è£…KiCadï¼ˆä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼‰
      - name: Setup KiCad environment
        if: steps.check-kicad.outputs.cached == 'false'
        run: |
          Write-Host "========================================"
          Write-Host "Installing KiCad and dependencies..."
          Write-Host "========================================"
          
          Write-Host "Installing Visual C++ Redistributable..."
          choco install vcredist-all -y --no-progress
          
          Write-Host ""
          Write-Host "Installing KiCad 9.0.6..."
          choco install kicad --version=9.0.6 -y --no-progress
          
          Write-Host ""
          Write-Host "Verifying installation..."
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          if (Test-Path $kicadCli) {
            Write-Host "KiCad installed successfully"
            & $kicadCli version
          } else {
            Write-Host "ERROR: KiCad installation failed"
            exit 1
          }
        shell: powershell
      
      # æ­¥éª¤4.5ï¼šé…ç½®ç¯å¢ƒå˜é‡
      - name: Configure KiCad PATH
        run: |
          # å°†KiCad binç›®å½•æ·»åŠ åˆ°å½“å‰ä¼šè¯çš„PATH
          $kicadBin = "C:\Program Files\KiCad\9.0\bin"
          $env:PATH = "$kicadBin;$env:PATH"
          
          # åŒæ—¶æ·»åŠ åˆ°åç»­æ­¥éª¤çš„PATH
          echo "$kicadBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "KiCad added to PATH: $kicadBin"
          Write-Host "Current PATH: $env:PATH"
        shell: powershell

       # æ­¥éª¤4.6ï¼šå®‰è£…é¢å¤–ä¾èµ–
      - name: Install additional dependencies
        run: |
          Write-Host "Installing .NET Framework, OpenGL, Python..."
          choco install dotnetfx -y
          choco install opengl -y
          choco install python -y
          Write-Host "Additional dependencies installed"
        shell: powershell


      # æ­¥éª¤6ï¼šè¿è¡ŒERCæ£€æŸ¥ï¼ˆç”µæ°”è§„åˆ™æ£€æŸ¥ï¼‰
      # æ£€æŸ¥åŸç†å›¾ä¸­çš„ç”µæ°”è¿æ¥é”™è¯¯ï¼Œå¦‚æœªè¿æ¥çš„å¼•è„šã€ç”µæºå†²çªç­‰
      - name: Run ERC (Electrical Rules Check)
        id: erc-check
        continue-on-error: true
        run: |
          Write-Host "=========================================="
          Write-Host "Starting ERC check with detailed diagnostics"
          Write-Host "=========================================="
          
          # 1. ç¯å¢ƒæ£€æŸ¥
          Write-Host ""
          Write-Host "[1] Environment Check"
          Write-Host "Current Directory: $PWD"
          Write-Host "User: $env:USERNAME"
          Write-Host "Computer: $env:COMPUTERNAME"
          Write-Host "OS: $env:OS"
          Write-Host "Processor: $env:PROCESSOR_ARCHITECTURE"
          
          # 2. æ£€æŸ¥æ–‡ä»¶
          Write-Host ""
          Write-Host "[2] File Check"
          $schFile = "229_Test.kicad_sch"
          if (-not (Test-Path $schFile)) {
            Write-Host "ERROR: Schematic file not found: $schFile"
            Write-Host "Available .kicad_sch files:"
            Get-ChildItem -Filter "*.kicad_sch" | ForEach-Object { Write-Host "  - $($_.Name)" }
            exit 1
          }
          $fileInfo = Get-Item $schFile
          Write-Host "Found schematic file: $schFile"
          Write-Host "  Size: $($fileInfo.Length) bytes"
          Write-Host "  Last Modified: $($fileInfo.LastWriteTime)"
          Write-Host "  Full Path: $($fileInfo.FullName)"
          
          # 3. KiCadå®‰è£…æ£€æŸ¥
          Write-Host ""
          Write-Host "[3] KiCad Installation Check"
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          if (-not (Test-Path $kicadCli)) {
            Write-Host "ERROR: kicad-cli.exe not found at: $kicadCli"
            exit 1
          }
          $cliInfo = Get-Item $kicadCli
          Write-Host "Found kicad-cli.exe:"
          Write-Host "  Path: $($cliInfo.FullName)"
          Write-Host "  Size: $($cliInfo.Length) bytes"
          Write-Host "  Version: $($cliInfo.VersionInfo.FileVersion)"
          
          # 4. æ£€æŸ¥KiCadç‰ˆæœ¬
          Write-Host ""
          Write-Host "[4] KiCad Version Check"
          try {
            & $kicadCli version 2>&1 | Write-Host
          } catch {
            Write-Host "ERROR: Failed to get KiCad version: $_"
          }
          
          # 5. æ£€æŸ¥ä¾èµ–é¡¹
          Write-Host ""
          Write-Host "[5] Dependencies Check"
          $dependencies = @(
            "C:\Windows\System32\vcruntime140.dll",
            "C:\Windows\System32\msvcp140.dll",
            "C:\Windows\System32\vcruntime140_1.dll"
          )
          foreach ($dll in $dependencies) {
            if (Test-Path $dll) {
              Write-Host "  OK: $dll"
            } else {
              Write-Host "  MISSING: $dll"
            }
          }
          
          # 6. æ£€æŸ¥æ˜¾ç¤ºç›¸å…³ç¯å¢ƒå˜é‡
          Write-Host ""
          Write-Host "[6] Display Environment Variables"
          Write-Host "  DISPLAY: $env:DISPLAY"
          Write-Host "  LIBGL_ALWAYS_INDIRECT: $env:LIBGL_ALWAYS_INDIRECT"
          Write-Host "  QT_QPA_PLATFORM: $env:QT_QPA_PLATFORM"
          
          # 7. å°è¯•åˆ—å‡ºå¯ç”¨å‘½ä»¤
          Write-Host ""
          Write-Host "[7] KiCad CLI Available Commands"
          try {
            & $kicadCli --help 2>&1 | Select-Object -First 30 | Write-Host
          } catch {
            Write-Host "ERROR: Failed to get help: $_"
          }
          
          # 8. æ£€æŸ¥ERCå‘½ä»¤å¸®åŠ©
          Write-Host ""
          Write-Host "[8] ERC Command Help"
          try {
            & $kicadCli sch erc --help 2>&1 | Write-Host
          } catch {
            Write-Host "ERROR: Failed to get ERC help: $_"
          }
          
          # 9. å‡†å¤‡è¿è¡ŒERC
          Write-Host ""
          Write-Host "[9] Preparing to Run ERC"
          Write-Host "Command: kicad-cli sch erc --exit-code-violations --severity-all --format json --output erc_report.json $schFile"
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "EXECUTING ERC CHECK NOW..."
          Write-Host "=========================================="
          
          # 10. è¿è¡ŒERCæ£€æŸ¥å¹¶æ•è·æ‰€æœ‰è¾“å‡º
          $ErrorActionPreference = 'Continue'
          $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
          
          try {
            & $kicadCli sch erc --exit-code-violations --severity-all --format json --output erc_report.json $schFile 2>&1 | Tee-Object -Variable ercOutput | Write-Host
            $exitCode = $LASTEXITCODE
            $stopwatch.Stop()
            
            Write-Host ""
            Write-Host "=========================================="
            Write-Host "ERC EXECUTION COMPLETED"
            Write-Host "=========================================="
            Write-Host "Exit Code: $exitCode (0x$([Convert]::ToString($exitCode, 16)))"
            Write-Host "Execution Time: $($stopwatch.Elapsed.TotalSeconds) seconds"
            
          } catch {
            $stopwatch.Stop()
            Write-Host ""
            Write-Host "=========================================="
            Write-Host "ERC EXECUTION FAILED WITH EXCEPTION"
            Write-Host "=========================================="
            Write-Host "Exception Type: $($_.Exception.GetType().FullName)"
            Write-Host "Exception Message: $($_.Exception.Message)"
            Write-Host "Stack Trace:"
            Write-Host $_.Exception.StackTrace
            Write-Host "Exit Code: $LASTEXITCODE (0x$([Convert]::ToString($LASTEXITCODE, 16)))"
            Write-Host "Execution Time: $($stopwatch.Elapsed.TotalSeconds) seconds"
            $exitCode = $LASTEXITCODE
          }
          
          # 11. æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
          Write-Host ""
          Write-Host "[11] Output File Check"
          if (Test-Path erc_report.json) {
            $reportInfo = Get-Item erc_report.json
            Write-Host "ERC report generated successfully:"
            Write-Host "  Path: $($reportInfo.FullName)"
            Write-Host "  Size: $($reportInfo.Length) bytes"
            Write-Host ""
            Write-Host "Report Content:"
            Write-Host "==========================================="
            Get-Content erc_report.json | Write-Host
            Write-Host "==========================================="
          } else {
            Write-Host "ERROR: ERC report file was NOT generated"
            Write-Host "Checking current directory contents:"
            Get-ChildItem | ForEach-Object { Write-Host "  - $($_.Name)" }
          }
          
          # 12. æœ€ç»ˆçŠ¶æ€
          Write-Host ""
          Write-Host "[12] Final Status"
          if ($exitCode -eq 0) {
            Write-Host "STATUS: ERC check PASSED - no violations found"
            "status=passed" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "violations=0" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } elseif ($exitCode -eq -1073741819) {
            Write-Host "STATUS: ERC check CRASHED with access violation (0xC0000005)"
            Write-Host "This typically indicates:"
            Write-Host "  - Missing DLL dependencies"
            Write-Host "  - Display/GUI initialization failure"
            Write-Host "  - OpenGL/graphics driver issues"
            Write-Host "  - Memory access violation"
            "status=crashed" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "violations=unknown" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "STATUS: ERC check FAILED with exit code $exitCode"
            "status=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "violations=1" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }
          
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "ERC DIAGNOSTIC COMPLETE"
          Write-Host "=========================================="
        shell: powershell
      
      # æ­¥éª¤7ï¼šè¿è¡ŒDRCæ£€æŸ¥ï¼ˆè®¾è®¡è§„åˆ™æ£€æŸ¥ï¼‰
      # æ£€æŸ¥PCBè®¾è®¡ä¸­çš„å¸ƒçº¿é”™è¯¯ï¼Œå¦‚é—´è·ä¸è¶³ã€æ‚¬ç©ºèµ°çº¿ç­‰
      - name: Run DRC (Design Rules Check)
        id: drc-check
        continue-on-error: true
        run: |
          Write-Host "Starting DRC check..."
          
          $pcbFile = "229_Test.kicad_pcb"
          if (-not (Test-Path $pcbFile)) {
            Write-Host "PCB file not found: $pcbFile"
            Get-ChildItem -Filter "*.kicad_pcb"
            exit 1
          }
          Write-Host "Found PCB file: $pcbFile"
          
          # ä½¿ç”¨kicad-cliè¿è¡ŒDRCï¼Œè¾“å‡ºJSONæŠ¥å‘Š
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          Write-Host "Running: kicad-cli pcb drc --exit-code-violations"
          
          # è¿è¡ŒDRCæ£€æŸ¥ï¼Œä½¿ç”¨--exit-code-violationsè®©æœ‰è¿è§„æ—¶è¿”å›é0é€€å‡ºç 
          & $kicadCli pcb drc --exit-code-violations --format json --output drc_report.json $pcbFile
          $exitCode = $LASTEXITCODE
          
          # æ£€æŸ¥ç»“æœ
          if ($exitCode -eq 0) {
            Write-Host "DRC check passed - no violations found"
          } else {
            Write-Host "WARNING: DRC check found violations (exit code: $exitCode)"
          }
          
          # è¾“å‡ºDRCæŠ¥å‘Šå†…å®¹
          if (Test-Path drc_report.json) {
            Write-Host ""
            Write-Host "DRC Report:"
            Write-Host "==========================================="
            Get-Content drc_report.json | Write-Host
            Write-Host "==========================================="
          } else {
            Write-Host "ERROR: DRC report file was not generated"
            exit 1
          }
          
          # ä¿å­˜DRCç»“æœçŠ¶æ€
          if ($exitCode -eq 0) {
            "status=passed" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "violations=0" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host ""
            Write-Host "DRC check found violations (will continue CI)"
            "status=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "violations=1" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            exit $exitCode
          }
        shell: powershell
      
      # æ­¥éª¤8ï¼šå¯¼å‡ºåŸç†å›¾ä¸ºPDFæ–‡æ¡£
      - name: Export Schematic PDF
        run: |
          Write-Host "Exporting schematic to PDF..."
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Force -Path outputs
          # å°†åŸç†å›¾å¯¼å‡ºä¸ºPDFæ ¼å¼ï¼Œæ–¹ä¾¿æŸ¥çœ‹å’Œæ‰“å°
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          & $kicadCli sch export pdf --output outputs/229_Test-Schematic.pdf 229_Test.kicad_sch
          Write-Host "Schematic PDF exported"
        shell: powershell
      
      # æ­¥éª¤6ï¼šå¯¼å‡ºBOMï¼ˆç‰©æ–™æ¸…å•ï¼‰
      - name: Export BOM
        run: |
          Write-Host "Exporting BOM..."
          # ä»åŸç†å›¾å¯¼å‡ºBOMæ¸…å•ï¼ˆCSVæ ¼å¼ï¼‰ï¼ŒåŒ…å«æ‰€æœ‰å…ƒä»¶ä¿¡æ¯
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          & $kicadCli sch export bom --output outputs/229_Test-BOM.csv 229_Test.kicad_sch
          Write-Host "BOM exported"
        shell: powershell
      
      # æ­¥éª¤7ï¼šç”ŸæˆGerberåˆ¶é€ æ–‡ä»¶
      - name: Generate Gerber files
        run: |
          Write-Host "Generating Gerber files..."
          # åˆ›å»ºGerberè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Force -Path outputs/gerber
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          
          # å¯¼å‡ºæ‰€æœ‰Gerberå±‚æ–‡ä»¶ï¼ˆç”¨äºPCBåˆ¶é€ ï¼‰
          & $kicadCli pcb export gerbers --output outputs/gerber/ 229_Test.kicad_pcb
          Write-Host "Gerber layers exported"
          
          # ç”Ÿæˆé’»å­”æ–‡ä»¶ï¼ˆExcellonæ ¼å¼ï¼‰
          & $kicadCli pcb export drill --format excellon --output outputs/gerber/ 229_Test.kicad_pcb
          Write-Host "Drill files generated"
        shell: powershell
      
      # æ­¥éª¤8ï¼šå¯¼å‡ºPCBå¯è§†åŒ–å›¾åƒ
      - name: Export PCB images
        run: |
          Write-Host "Exporting PCB images..."
          $kicadCli = "C:\Program Files\KiCad\9.0\bin\kicad-cli.exe"
          
          $ErrorActionPreference = 'Continue'
          
          # å¯¼å‡ºPCBæ­£é¢è§†å›¾ï¼ˆSVGæ ¼å¼ï¼‰
          & $kicadCli pcb export svg --output outputs/229_Test-PCB-Front.svg --layers F.Cu,F.Mask,F.Silkscreen,Edge.Cuts 229_Test.kicad_pcb 2>&1 | Write-Host
          if (Test-Path "outputs/229_Test-PCB-Front.svg") {
            Write-Host "Front PCB image exported successfully"
          }
          
          # å¯¼å‡ºPCBèƒŒé¢è§†å›¾ï¼ˆSVGæ ¼å¼ï¼‰
          & $kicadCli pcb export svg --output outputs/229_Test-PCB-Back.svg --layers B.Cu,B.Mask,B.Silkscreen,Edge.Cuts 229_Test.kicad_pcb 2>&1 | Write-Host
          if (Test-Path "outputs/229_Test-PCB-Back.svg") {
            Write-Host "Back PCB image exported successfully"
          }
          
          # å¯¼å‡º3D STEPæ¨¡å‹
          & $kicadCli pcb export step --output outputs/229_Test-3D.step 229_Test.kicad_pcb 2>&1 | Write-Host
          if (Test-Path "outputs/229_Test-3D.step") {
            Write-Host "3D STEP model exported successfully"
          } else {
            Write-Host "3D export skipped (may require 3D models)"
          }
          
          Write-Host "PCB image export completed"
          exit 0
        shell: powershell
      
      # æ­¥éª¤9ï¼šæ‰“åŒ…Gerberæ–‡ä»¶ä¸ºZIPå‹ç¼©åŒ…
      - name: Create Gerber ZIP archive
        run: |
          # å°†æ‰€æœ‰Gerberæ–‡ä»¶æ‰“åŒ…ï¼Œæ–¹ä¾¿ä¸‹è½½å’Œæäº¤ç»™PCBå‚å•†
          Compress-Archive -Path outputs/gerber/* -DestinationPath outputs/229_Test-Gerber.zip -Force
        shell: powershell
      
      # æ­¥éª¤10ï¼šä¸Šä¼ æ„å»ºäº§ç‰©åˆ°GitHub Artifacts
      # å¯åœ¨Actionsé¡µé¢ä¸‹è½½ï¼Œä¿ç•™90å¤©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kicad-outputs
          path: outputs/
      
      # æ­¥éª¤11ï¼šç”Ÿæˆæ„å»ºæ‘˜è¦æ–‡æ¡£
      - name: Update README with status
        run: |
          # åˆ›å»ºåŒ…å«æ„å»ºä¿¡æ¯çš„Markdownæ‘˜è¦æ–‡ä»¶
          # è¯¥æ–‡ä»¶å°†è¢«ç”¨ä½œReleaseçš„è¯´æ˜
          $buildDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC")
          $cacheStatus = if ('${{ steps.cache-kicad.outputs.cache-hit }}' -eq 'true') { 'Used cached installation' } else { 'Fresh installation' }
          
          # ERC/DRCçŠ¶æ€
          $ercStatus = if ('${{ steps.erc-check.outputs.status }}' -eq 'passed') { 'âœ… Passed' } else { 'âŒ Failed' }
          $drcStatus = if ('${{ steps.drc-check.outputs.status }}' -eq 'passed') { 'âœ… Passed' } else { 'âŒ Failed' }
          
          @"
          ## Build Summary
          
          - **Build Date**: $buildDate
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **KiCad Setup**: $cacheStatus
          
          ### Quality Checks
          
          - **ERC (Electrical Rules Check)**: $ercStatus
          - **DRC (Design Rules Check)**: $drcStatus
          
          ### Outputs
          
          - âœ… Schematic PDF
          - âœ… BOM (Bill of Materials)
          - âœ… Gerber files
          - âœ… PCB Images (SVG)
          - ERC Report (JSON)
          - DRC Report (JSON)
          
          "@ | Out-File -FilePath outputs/build_summary.md -Encoding utf8
        shell: powershell
      
      # æ­¥éª¤12ï¼šå‡†å¤‡Releaseæ–‡ä»¶ï¼ˆåªåŒ…å«æˆåŠŸç”Ÿæˆçš„æ–‡ä»¶ï¼Œç²¾ç®€è¾“å‡ºï¼‰
      - name: Prepare release files
        run: |
          Write-Host "Preparing release files..."
          New-Item -ItemType Directory -Force -Path release
          
          # åªå¤åˆ¶å…³é”®æ–‡ä»¶,ä¸åŒ…å«æ•£ä¹±çš„Gerberæ–‡ä»¶
          $filesToCopy = @(
            "outputs/229_Test-Schematic.pdf",
            "outputs/229_Test-BOM.csv",
            "outputs/229_Test-Gerber.zip",
            "outputs/229_Test-PCB-Front.svg",
            "outputs/229_Test-PCB-Back.svg",
            "outputs/229_Test-3D.step"
          )
          
          Write-Host "Copying key output files:"
          foreach ($file in $filesToCopy) {
            if (Test-Path $file) {
              $fileName = Split-Path $file -Leaf
              Copy-Item $file "release/$fileName"
              Write-Host "  âœ“ $fileName"
            } else {
              Write-Host "  âœ— $fileName (not found)"
            }
          }
          
          # å¦‚æœERC/DRCæŠ¥å‘Šå­˜åœ¨ï¼Œä¹Ÿå¤åˆ¶å®ƒä»¬
          if (Test-Path erc_report.json) {
            Copy-Item erc_report.json release/
            Write-Host "  âœ“ erc_report.json"
          } else {
            Write-Host "  âœ— erc_report.json (check crashed)"
          }
          
          if (Test-Path drc_report.json) {
            Copy-Item drc_report.json release/
            Write-Host "  âœ“ drc_report.json"
          } else {
            Write-Host "  âœ— drc_report.json (check crashed)"
          }
          
          Write-Host ""
          Write-Host "Final release files:"
          Get-ChildItem -Path release | ForEach-Object { Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1KB, 2)) KB)" }
        shell: powershell
      
      # æ­¥éª¤13ï¼šåˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
      # ä»…åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶æ‰§è¡Œï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸åˆ›å»ºReleaseï¼‰
      - name: Create Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}          # ä½¿ç”¨æ„å»ºç¼–å·ä½œä¸ºæ ‡ç­¾
          name: Build ${{ github.run_number }}              # Releaseæ ‡é¢˜
          body_path: outputs/build_summary.md               # Releaseè¯´æ˜å†…å®¹
          files: release/**/*                                # ä¸Šä¼ releaseç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
          fail_on_unmatched_files: false                    # æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¸æŠ¥é”™
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}         # ä½¿ç”¨GitHubæä¾›çš„è®¿é—®ä»¤ç‰Œ
      
      # æ­¥éª¤14ï¼šè¾“å‡ºCI/CDæ‰§è¡Œç»“æœæ‘˜è¦
      - name: Display CI/CD Results
        if: always()
        run: |
          Write-Host ""
          Write-Host "==========================================" -ForegroundColor Cyan
          Write-Host "  KiCad CI/CD æ‰§è¡Œç»“æœ" -ForegroundColor Cyan
          Write-Host "==========================================" -ForegroundColor Cyan
          Write-Host ""
          
          # æ„å»ºä¿¡æ¯
          Write-Host "ğŸ“‹ æ„å»ºä¿¡æ¯:" -ForegroundColor Yellow
          Write-Host "  â€¢ æ„å»ºç¼–å·: ${{ github.run_number }}"
          Write-Host "  â€¢ æäº¤SHA: ${{ github.sha }}"
          Write-Host "  â€¢ åˆ†æ”¯: ${{ github.ref_name }}"
          Write-Host "  â€¢ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          Write-Host ""
          
          # è´¨é‡æ£€æŸ¥ç»“æœ
          Write-Host "ğŸ” è´¨é‡æ£€æŸ¥:" -ForegroundColor Yellow
          $ercStatus = "${{ steps.erc-check.outputs.status }}"
          $drcStatus = "${{ steps.drc-check.outputs.status }}"
          
          if ($ercStatus -eq "passed") {
            Write-Host "  â€¢ ERCæ£€æŸ¥: âœ… é€šè¿‡" -ForegroundColor Green
          } elseif ($ercStatus -eq "crashed") {
            Write-Host "  â€¢ ERCæ£€æŸ¥: âš ï¸ å´©æºƒ (CIç¯å¢ƒé™åˆ¶)" -ForegroundColor Yellow
          } elseif ($ercStatus -eq "failed") {
            Write-Host "  â€¢ ERCæ£€æŸ¥: âŒ å‘ç°è¿è§„" -ForegroundColor Red
          } else {
            Write-Host "  â€¢ ERCæ£€æŸ¥: â­ï¸ è·³è¿‡" -ForegroundColor Gray
          }
          
          if ($drcStatus -eq "passed") {
            Write-Host "  â€¢ DRCæ£€æŸ¥: âœ… é€šè¿‡" -ForegroundColor Green
          } elseif ($drcStatus -eq "crashed") {
            Write-Host "  â€¢ DRCæ£€æŸ¥: âš ï¸ å´©æºƒ (CIç¯å¢ƒé™åˆ¶)" -ForegroundColor Yellow
          } elseif ($drcStatus -eq "failed") {
            Write-Host "  â€¢ DRCæ£€æŸ¥: âŒ å‘ç°è¿è§„" -ForegroundColor Red
          } else {
            Write-Host "  â€¢ DRCæ£€æŸ¥: â­ï¸ è·³è¿‡" -ForegroundColor Gray
          }
          Write-Host ""
          
          # è¾“å‡ºæ–‡ä»¶
          Write-Host "ğŸ“¦ ç”Ÿæˆæ–‡ä»¶:" -ForegroundColor Yellow
          if (Test-Path "outputs/229_Test-Schematic.pdf") {
            Write-Host "  â€¢ âœ… åŸç†å›¾PDF"
          }
          if (Test-Path "outputs/229_Test-BOM.csv") {
            Write-Host "  â€¢ âœ… BOMç‰©æ–™æ¸…å•"
          }
          if (Test-Path "outputs/229_Test-Gerber.zip") {
            $size = [math]::Round((Get-Item "outputs/229_Test-Gerber.zip").Length / 1KB, 2)
            Write-Host "  â€¢ âœ… Gerberåˆ¶é€ æ–‡ä»¶ ($size KB)"
          }
          if (Test-Path "outputs/229_Test-PCB-Front.svg") {
            Write-Host "  â€¢ âœ… PCBæ­£é¢å›¾åƒ"
          }
          if (Test-Path "outputs/229_Test-PCB-Back.svg") {
            Write-Host "  â€¢ âœ… PCBèƒŒé¢å›¾åƒ"
          }
          if (Test-Path "outputs/229_Test-3D.step") {
            Write-Host "  â€¢ âœ… 3D STEPæ¨¡å‹"
          }
          Write-Host ""
          
          # Releaseä¿¡æ¯
          if ("${{ github.event_name }}" -eq "push" -and ("${{ github.ref }}" -eq "refs/heads/main" -or "${{ github.ref }}" -eq "refs/heads/master")) {
            Write-Host "ğŸš€ Release:" -ForegroundColor Yellow
            Write-Host "  â€¢ æ ‡ç­¾: build-${{ github.run_number }}"
            Write-Host "  â€¢ æŸ¥çœ‹: https://github.com/${{ github.repository }}/releases/tag/build-${{ github.run_number }}"
          } else {
            Write-Host "â„¹ï¸  æ‰‹åŠ¨è§¦å‘æ„å»ºï¼Œæœªåˆ›å»ºRelease" -ForegroundColor Gray
          }
          
          Write-Host ""
          Write-Host "==========================================" -ForegroundColor Cyan
          Write-Host "  âœ¨ CI/CD æµç¨‹å®Œæˆ" -ForegroundColor Cyan
          Write-Host "==========================================" -ForegroundColor Cyan
        shell: powershell
